<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale-1.0">
    <title>Secure Office Login</title>
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="login-wrapper">
        <div class="branding-section">
            <i class="fas fa-lock-open logo-icon"></i>
            <h2>Secure Access</h2>
            <p>Your biometric gateway to the workplace.</p>
        </div>
        
        <div class="login-form-section">
            <h1>Facial Recognition Login</h1>
            
            <div class="webcam-container">
                <video id="webcam" autoplay muted playsinline></video>
                <div class="webcam-overlay"></div>
            </div>
            
            <canvas id="snapshot" style="display: none;"></canvas>
            
            <button id="login-button">
                <i class="fas fa-fingerprint"></i> Login Now
            </button>
            
            <p id="status" class="status-message">Status: Initializing webcam...</p>
        </div>
    </div>

    <script>
        // Get references (same as before)
        const video = document.getElementById('webcam');
        const loginButton = document.getElementById('login-button');
        const statusMsg = document.getElementById('status');
        const canvas = document.getElementById('snapshot');
        const context = canvas.getContext('2d');

        // startWebcam() function (same as before)
        async function startWebcam() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 640, height: 480 },
                    audio: false 
                });
                video.srcObject = stream;
            } catch (err) {
                console.error("Error accessing webcam: ", err);
                statusMsg.textContent = "Error: Could not access webcam.";
            }
        }

        // loginButton event listener (same as before)
        loginButton.addEventListener('click', login);

        // login() function (UPDATED)
        async function login() {
            statusMsg.textContent = "Identifying...";
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageDataURL = canvas.toDataURL('image/jpeg');

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: imageDataURL })
                });

                const result = await response.json();

                // --- THIS IS THE UPDATED PART ---
                if (result.success && result.redirect) {
                    // Success! Redirect to the dashboard.
                    statusMsg.textContent = "Success! Redirecting...";
                    window.location.href = result.redirect;
                } else {
                    // Failure
                    statusMsg.textContent = "Access Denied: Face not recognized.";
                    statusMsg.style.color = "red"; // Will be overridden by CSS
                }
                // --- END OF UPDATED PART ---

            } catch (error) {
                console.error("Error during login request: ", error);
                statusMsg.textContent = "Error: Could not connect to server.";
                statusMsg.style.color = "red"; // Will be overridden by CSS
            }
        }

        // Start webcam (same as before)
        startWebcam();
    </script>
    </script>
    </body>
</html>